<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Admin - Series de Taylor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            min-height: 100vh;
        }

        .dashboard-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            max-width: 1200px;
            width: 100%;
        }

        h1, h2 {
            text-align: center;
            color: #333;
        }

        .grafico, .fibonacii {
            margin: 20px 0;
        }

        .logout-button {
            background-color: #dc3545;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .logout-button:hover {
            background-color: #c82333;
        }

        .input-container {
            margin-bottom: 20px;
            text-align: center;
        }

        .input-container select, .fibonacci-input {
            padding: 10px;
            width: 150px;
            margin-right: 10px;
        }

        .input-container button, .fibonacci-button {
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .input-container button:hover, .fibonacci-button:hover {
            background-color: #218838;
        }

        .fibonacci-button.delete {
            background-color: #dc3545;
        }

        .fibonacci-button.delete:hover {
            background-color: #c82333;
        }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <button class="logout-button" onclick="logout()">Cerrar Sesión</button>
        <h1>Dashboard de Admin - Estado de las vaquetas</h1>

        <div class="input-container">
            <label for="filter-pk">Filtrar por PK de usuario:</label>
            <select id="filter-pk">
                <option value="">Todos</option> <!-- Opción para no filtrar por PK -->
            </select>

            <label for="filter-ip">Filtrar por IP de usuario:</label>
            <select id="filter-ip">
                <option value="">Todos</option> <!-- Opción para no filtrar por IP -->
            </select>
        </div>

        <!-- Seno Section -->
        <!-- <div class="grafico">
            <h2>Seno</h2>
            <div id="grafico_seno" style="width:100%;height:300px;"></div>
        </div> -->

        <!-- Coseno Section -->
        <!-- <div class="grafico">
            <h2>Coseno</h2>
            <div id="grafico_coseno" style="width:100%;height:300px;"></div>
        </div> -->

        <!-- Tangente Section -->
        <!-- <div class="grafico">
            <h2>Tangente</h2>
            <div id="grafico_tangente" style="width:100%;height:300px;"></div>
        </div> -->

        <!-- Actividad de Usuarios Section -->
        <div class="grafico">
            <h2>Actividad de Usuarios</h2>
            <div id="grafico_actividad" style="width:100%;height:300px;"></div>
        </div> 

        <!-- Fibonacii Section -->
        <div class="fibonacii">
            <h2>DrumHit</h2>
            <div class="input-container">
                <!-- <label for="fibonacci-m">Número de términos (m):</label>
                <input type="number" id="fibonacci-m" class="fibonacci-input" min="1" value="5"> -->
                <!-- <button class="fibonacci-button" onclick="addFibonacci()">Añadir Términos</button> -->
                <button class="fibonacci-button delete" onclick="deleteFibonacci()">Eliminar Todos</button>
            </div>
            <div id="grafico_fibonacii" style="width:100%;height:300px;"></div>
        </div>

    </div>

    <script>

        const BASE_URL = "{{ base_url }}"

        let sineDataFull = [];  
        let cosineDataFull = [];  
        let tangentDataFull = [];  
        let activityDataFull = [];
        let fibonacciDataFull = [];
        let usuarios = [];
        let currentPk = ''; 
        let currentIp = ''; 

        window.onload = async function() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Por favor, inicie sesión para acceder al dashboard');
                window.location.href = `${BASE_URL}tienda/login/`;
                return;
            }
            await obtenerUsuarios(token);
            await obtenerFibonacii(token);

            setInterval(async function() {
                await obtenerSeries(token);
                await obtenerFibonacii(token);
                aplicarFiltros();
            }, 500);
        };

        function logout() {
            localStorage.clear();
            window.location.href = `${BASE_URL}tienda/login/`;
        }

        async function obtenerUsuarios(token) {
            try {
                const response = await fetch(`${BASE_URL}tienda/user/`, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Token ' + token,
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error('Error al obtener los usuarios.');
                }

                usuarios = await response.json();

                // Llenar selectores de PK e IP
                const filterPkSelect = document.getElementById('filter-pk');
                const filterIpSelect = document.getElementById('filter-ip');

                usuarios.forEach(usuario => {
                    const optionPk = document.createElement('option');
                    optionPk.value = usuario.pk;
                    optionPk.textContent = `PK: ${usuario.pk} - ${usuario.email}`;
                    filterPkSelect.appendChild(optionPk);

                    const optionIp = document.createElement('option');
                    optionIp.value = usuario.ip ? usuario.ip : '';
                
                    optionIp.textContent = usuario.ip ? `IP: ${usuario.ip}` : 'IP: ""';
                    filterIpSelect.appendChild(optionIp);
                });

            } catch (error) {
                console.error('Error al obtener usuarios:', error);
            }
        }

        async function obtenerSeries(token) {
            try {
                activityDataFull = await fetchSeries('activity', token);

                generarGraficoActividad('grafico_actividad', activityDataFull, 'Actividad de usuarios');
            } catch (error) {
                console.error('Error al obtener las series:', error);
            }
        }

        async function fetchSeries(type, token) {
            const response = await fetch(`${BASE_URL}tienda/${type}/`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Token ' + token,
                    'Content-Type': 'application/json',
                }
            });

            if (!response.ok) {
                throw new Error(`Error al obtener la serie ${type}`);
            }
            return await response.json();
        }

        async function obtenerFibonacii(token) {
            try {
                fibonacciDataFull = await fetchFibonacii(token);
                generarGraficoFibonacii(fibonacciDataFull);
            } catch (error) {
                console.error('Error al obtener Fibonacii:', error);
            }
        }

        async function fetchFibonacii(token) {
            const response = await fetch(`${BASE_URL}tienda/drum/`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Token ' + token,
                    'Content-Type': 'application/json',
                }
            });

            if (!response.ok) {
                throw new Error('Error al obtener Fibonacii.');
            }
            return await response.json();
        }


        async function deleteFibonacci() {
            const token = localStorage.getItem('token');

            if (!confirm('¿Está seguro de que desea eliminar todas las entradas de Fibonacii?')) {
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}tienda/drum/1/`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Token ' + token,
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error('Error al eliminar entradas de Fibonacii.');
                }

                await obtenerFibonacii(token);
                alert('Todas las entradas de Fibonacii han sido eliminadas.');
            } catch (error) {
                console.error('Error al eliminar Fibonacii:', error);
            }
        }

        function generarGraficoActividad(id, data, titulo){
            const labels = data.map(item => item.ip);
            const activity = data.map(item => item.actividad);

            const layout = {
                title: titulo,
                xaxis: {title: 'IP'},
                yaxis: {title: '#Registros'},
                showlegend: true,
            }

            const trace1 = {
                x: labels,
                y: activity,
                type:"bar",
                name: "Actividad",
            }

            Plotly.react(id, [trace1], layout)
        }

        function generarGraficoFibonacii(data, titulo = 'Toques') {

            const ips = new Set(data.map(item => item.ip))            
            const time = data.map(item => item.time);
            const fibonacciValues = data.map(item => item.value);

            const layout = {
                title: titulo,
                xaxis: { title: 'Tiempo' },
                yaxis: { title: 'Intensidad del golpe' },
                showlegend: true
            };


            traces =[]
            for(let ip of ips){
                
                let t = time.filter((item, index)=> data[index].ip==ip)
                let v = fibonacciValues.filter((item, index)=> data[index].ip==ip)

                traces.push(
                    {
                        x: t,
                        y: v,
                        mode: 'lines+markers',
                        name: `${ip}`
                    }
                )
            }

            console.log(traces)

            Plotly.react('grafico_fibonacii', traces, layout);
        }

        function aplicarFiltros() {
            const pk = currentPk;  
            const ip = currentIp;  

            const sineDataFiltered = sineDataFull.filter(item => 
                (!pk || item.user.pk == pk) && (!ip || item.user.ip == ip)
            );
            const cosineDataFiltered = cosineDataFull.filter(item => 
                (!pk || item.user.pk == pk) && (!ip || item.user.ip == ip)
            );
            const tangentDataFiltered = tangentDataFull.filter(item => 
                (!pk || item.user.pk == pk) && (!ip || item.user.ip == ip)
            );

            const fibonacciDataFiltered = fibonacciDataFull.filter(item => 
                (!pk || (item.ip && usuarios.find(u => u.pk == pk && u.ip == item.ip))) &&
                (!ip || item.ip == ip)
            );

        
            generarGraficoFibonacii(fibonacciDataFiltered);
        }

        document.getElementById('filter-pk').addEventListener('change', function() {
            currentPk = this.value; 
            aplicarFiltros();
        });

        document.getElementById('filter-ip').addEventListener('change', function() {
            currentIp = this.value; 
            aplicarFiltros();  
        });

    </script>

</body>
</html>
